module.exports = {import:convert};

/*
4|47675934||ONT651803027|20180905|63073242|5|2214.40|2680.00|.00|.00|2214.40|2679.40|
|200.00||9.35|11.31|21.0|||||Strikacka injekcni tridilna TERUMO 50ml catheter tip - zanetka (25ks/bal) (SS+50C1)=TER2BS50C||
MER034009013|2.00||32.10|38.84|21.0|||||Teplomer chladnickovy -30+40
VIT641331213200|2.00||48.60|58.81|21.0|||||Tloucek treci drsny,  213a/2  30x135mm (JIZE213A/2)|VIT641331213200|
VIT641331211120|1.00||97.20|117.61|21.0|||||Miska treci drsna, 75ml|VIT641331211120|
|1.00||85.80|103.82|21.0|||||Tloucek treci drsny, 42 x 175 mm||
*/

function convert(data)
{
  if (typeof(data) != "object" || !data.length || data.length < 2)
    return false;

  var partner = data[0];
  var partnerKey = partner[3].substr(0, 5);

  if (!data) 
  {
    return false;
  }

  if (data[0].length < 13)
    return false;

  var partners = {
    "ONT33,ONTS1,ONTS2,ONTS3,ONTS4,ONTS5,ONTS6,ONTS7,ONTS8,ONTS9,ONTS0" : {
      partnerIdSold: "26002813",
      partnerIdShip: "26006315",
      partnerName: "Perfect",
      address: ["Perfect Distribution a.s. (Třinec)", "Konská 198", "Třinec", "739 61", "CZ"],
      contact: ["libuse.styskalova@pfd.agel.cz", "+420 606 784 687"] // nemame mail a cislo!
    },
    "ONT44,ONT65" : {
      partnerIdSold: "26002813",
      partnerIdShip: "26005857",
      partnerName: "Perfect",
      address: ["Perfect Distribution a.s. Airport Logistic Park", "Kněževes 185", "Kněževes", "252 68", "CZ"],
      contact: ["libuse.styskalova@pfd.agel.cz", "+420 606 784 687"] // nemame mail a cislo!
    },
    "ONT45,ONT55" : {
      partnerIdSold: "26002813",
      partnerIdShip: "26002813",
      partnerName: "Perfect",
      address: ["Perfect Distribution a.s.", "U spalovny 4582/17", "Prostějov", "796 01", "CZ"],
      contact: ["libuse.styskalova@pfd.agel.cz", "+420 606 784 687"] // nemame mail a cislo!
    }
  }

  var result = {
    id: "perfect",
    header: {
      documentId: partner[3],      
      purchaseTimestamp: partner[4],
    },
    items: [],
    messages: []
  };

  for (var pid in partners)
  {
    if (pid.indexOf(partnerKey) != -1)
    {
      var partnerInfo = partners[pid];
      for (var i in partnerInfo)
        result.header[i] = partnerInfo[i];
    }
  }

  if (!result.header.partnerIdShip)
  {
    console.log("Error, cannot match partner id " + partnerKey);
    result.messages.push("Error, cannot match partner id " + partnerKey);
    return false;
  }

  data.shift();

  for (i in data)
  {
    var item = data[i];
    if (item.length < 14)
      return false;

    var id = item[13];
    if (!id || id == "")
      return false;

    var vwrId = conversionTable[id];
    if (!vwrId)
    {
      result.messages.push("Warning, cannot match product id " + id);
      vwrId = id;
    }

    var packQuantity = quantityTable[id];
    if (!packQuantity)
      packQuantity = 1;
    else
    {
      if ((item[1] % packQuantity) != 0)
        result.messages.push("Warning, pack quantity not divisible " + vwrId + " qty: " + item[1] + " pack: " + packQuantity);
    }
 
    result.items.push({
      ean:vwrId, 
      name:item[10],
      quantity:item[1]/packQuantity,
      price:item[3]
    });
  }

  return result;
}

var conversionTable = {
"GAM400927":"GAMA400927",
"PHA713865":"NEDFALTEST",
"REG-VIT-221120341100":"MACH120-341-1000",
"REG-VWR-17-1440-02":"17-1440-02",
"REG-VWR-20599.297":"20599.297",
"REG-VWR-24311.320":"24311.320",
"REG-VWR-83650.320P":"83650.320",
"REG-VWR-LACH10033A35M1000":"LACH10033A35M1000",
"VIT100001683":"EXAT1683",
"VIT1000078":"MARI1000200091",
"VIT100105511":"EXAT105511",
"VIT100125101":"EXAT125101",
"VIT111-0930":"111-0930",
"VIT111-2279":"111-2279",
"VIT-112-2371":"112-2371",
"VIT112-2689":"112-2689",
"VIT113050503":"IBSASP0029003",
"VIT113-0645":"113-0645",
"VIT113-0646":"113-0646",
"VIT113-6152":"113-6152",
"VIT203801001":"VITU801001",
"VIT-20821.296":"20821.296",
"VIT-20823.293":"20823.293",
"VIT-20842.367":"20842.367",
"VIT-20864.320":"20864.320",
"VIT211-0344":"211-0344",
"VIT-212-0326":"212-0326",
"VIT-212-0473":"212-0473",
"VIT-212-0517":"212-0517",
"VIT-212-0634":"212-0634",
"VIT215-6511":"215-6511",
"VIT216-0791":"216-0791",
"VIT216-0792":"216-0792",
"VIT216-0793":"216-0793",
"VIT216-1342":"216-1342",
"VIT216-1408":"216-1408",
"VIT216-1502":"216-1502",
"VIT216-2639":"216-2639",
"VIT221-1816":"221-1816",
"VIT222521004":"KAKO2521004",
"VIT222526008":"KAKO2526008",
"VIT222526009":"KAKO2526009",
"VIT222526013":"KAKO2526013",
"VIT222526014":"KAKO2526014",
"VIT224416428":"KAKO4416428",
"VIT238102000":"GAMA204809",
"VIT238105000":"GAMA204808",
"VIT-253150201614":"LACH51015000P00001",
"VIT-253380005504":"TOPP05504",
"VIT282224411411":"KAKO4411411",
"VIT28222526006":"KAKO2526006",
"VIT-28973.363":"28973.363",
"VIT293-4186":"293-4186",
"VIT331000458815":"IBSA458815",
"VIT331092600111":"612-1746",
"VIT3313690251350":"FLME25135",
"VIT331383243045":"VITU383243045.010",
"VIT-331600471800":"BOET05.011.0100",
"VIT331690211520":"FLME21152",
"VIT331690221350":"FLME22135",
"VIT331690222540":"FLME22254",
"VIT331690226720":"FLME22672",
"VIT331690229520":"FLME22952",
"VIT331690250350":"FLME25035",
"VIT331690251340":"FLME25134",
"VIT331690251710":"FLME25171",
"VIT331690251850-BAL":"FLME25185",
"VIT331690270550":"FLME27055",
"VIT-331693391111":"FLME28063",
"VIT331707645941":"612-2423",
"VIT331707648081":"612-3788",
"VIT331707649081":"612-3789",
"VIT331707652081":"612-4314",
"VIT331707653941":"612-4357",
"VIT331850001637":"215-9010",
"VIT331850041637":"215-9012",
"VIT331850041638":"215-9013",
"VIT331850061637":"215-9014",
"VIT331950080009":"129-0324",
"VIT331998002022":"IBSABSA022/G",
"VIT-332200304410":"VITU304410",
"VIT336707441941":"GLAS179.303.02",
"VIT336850000150":"GLAS122.303.03",
"VIT336850001079":"GLAS178.303.04",
"VIT388034009013":"VITU8586003880266",
"VIT38810000202":"EXAT221200",
"VIT388100080800":"EXAT080800",
"VIT388100700023":"EXAT700023",
"VIT388100800001":"EXAT801110",
"VIT391-2730":"VTRB632492003100",
"VIT-394030000978":"613-3508",
"VIT-395321056005":"291-1211",
"VIT396935260020":"609-0127",
"VIT-397210003340":"SCNG252",
"VIT-397402999998":"IBSA397402999998",
"VIT399100232705":"BURK2327-0050",
"VIT399100232710":"BURK2327-0010",
"VIT414212100":"VTRA632414212100",
"VIT417010250":"VTRB632417010250",
"VIT432141238":"VTRB632432141238",
"VIT432151130":"VTRB632432151130",
"VIT432554845":"VTRA632432554845_U",
"VIT548-3018":"548-3018",
"VIT609-0184":"609-0184",
"VIT612-3833":"612-3833",
"VIT612-9352":"612-9352",
"VIT612-9354":"612-9354",
"VIT613-2050":"613-2050",
"VIT613-3500":"613-3500",
"VIT613-3503":"613-3503",
"VIT613-3504":"613-3504",
"VIT613-3505":"613-3505",
"VIT613-3881":"613-3881",
"VIT613-4902":"613-4902",
"VIT613-5398":"613-5398",
"VIT-624703102110":"516-0707",
"VIT624703102150":"516-0709",
"VIT-624703205110":"BINZ3.205.110",
"VIT-624723025858":"BINZ123002",
"VIT624880565050":"PPERM2/56G/50X50",
"VIT624880805050":"PPERPN/80G/M2",
"VIT631-0108":"631-0108",
"VIT631-0739":"631-0739",
"VIT631-1109":"631-1109",
"VIT631-1128":"631-1128",
"VIT631-1129":"631-1129",
"VIT631-1132":"631-1132",
"VIT631-1133":"631-1133",
"VIT632411010025":"VTRB632411010025",
"VIT632411010050":"VTRB632411010050",
"VIT632411012025":"VTRB632411012025",
"VIT632411012050":"VTRB632411012050",
"VIT632411119952":"VTRB632411119952",
"VIT632413001055":"VTRB632413001055",
"VIT632414204250":"VTRA632414204250",
"VIT-632417010100":"VTRB632417010100",
"VIT-632417010150":"VTRB632417010150",
"VIT-632417010400":"VTRB632417010400",
"VIT-632417010600":"VTRB632417010600",
"VIT-632417010800":"VTRB632417010800",
"VIT632417010940":"VTRB632417010940",
"VIT632417012100":"VTRB632417012100",
"VIT632417012150":"VTRB632417012150",
"VIT632417012250":"VTRB632417012250",
"VIT632417012600":"VTRB632417012600",
"VIT632417012940":"VTRB632417012940",
"VIT632417106940":"VTRB632417106940",
"VIT632417106950":"VTRB632417106950",
"VIT632422010110":"VTRB632422010110",
"VIT-632422015116":"VTRB632422015116",
"VIT632432110819":"VTRB632432110819",
"VIT-632432110923":"VTRB632432110923",
"VIT-632432111125":"VTRB632432111125",
"VIT632432111343":"VTRB632432111343",
"VIT-632432111444":"VTRB632432111444",
"VIT632432511746":"VTRB632432511746",
"VIT-632499890004":"HAVA632499890004",
"VIT632499890010":"HAVA632499890010",
"VIT632522205503":"VTRA7765/6X300",
"VIT-632524325025":"TNOS632524325025",
"VIT632538160080":"VTRB632538160080",
"VIT633516001515":"HAVA12300606231434",
"VIT634423014097":"212-0017",
"VIT634424155100":"KIML634424155100",
"VIT634986311500":"631-1550",
"VIT63499010103":"631-0656",
"VIT634990810401":"MARI0810401",
"VIT635901000076":"VTRA635901000076",
"VIT635901000078":"VTRA635901000078",
"VIT636009520202":"GLAS095.202.02",
"VIT636012420204":"GLAS124.202.04",
"VIT636013020210":"GLAS130.202.10",
"VIT639025001165":"VTRA639025001165",
"VIT641331211100":"JIZE211A/1",
"VIT641331211120":"JIZE211A/1A",
"VIT641331213100":"JIZE213A/1",
"VIT641331213101":"JIZE213B/1",
"VIT641331213200":"JIZE213A/2",
"VIT641331213201":"JIZE213B/2",
"VIT641331213400":"JIZE213A/4",
"VIT690210170":"FLME21017",
"VIT690213270":"FLME21327",
"VIT690230520":"FLMEBSA021",
"VIT690250620":"FLME25062",
"VIT690250720":"FLME25072",
"VIT690251750":"FLME25175",
"VIT690253030":"FLME25303",
"VIT707065295":"612-0957",
"VIT707441941":"213-0262",
"VIT707443081":"213-3730",
"VIT707447941":"213-0256",
"VIT707978941":"VITL978941",
"VIT720-2526":"720-2526",
"VIT720-2527":"720-2527",
"VIT720-2528":"720-2528",
"VIT793175800523-BAL":"CANS8005-23",
"VIT-8930":"BOCH8930",
"VIT998000008400":"IBSA37580101",
//"VIT-BURK2327-0030
"VITDELT-202847-ks":"DELT202847",
"VITEXAT105013":"EXAT105013",
"VITEXAT111055":"EXAT111055",
"VITFLME21056":"FLME21056",
"VITFLME21361":"FLME21361",
"VITGLAS122.303.02":"GLAS122.303.02",
"VITGLAS524.303.04":"GLAS524.303.04",
"VITHAVA12300404231434":"HAVA12300404231434",
"VITJIZE211A/1/0":"JIZE211A/1/0",
"VITJIZE211A/2":"JIZE211A/2",
"VITJIZE211B/1/0":"JIZE211B/1/0",
"VITJIZE211B/2":"JIZE211B/2",
"VITJIZE213A/O":"JIZE213A/0",
"VITKAVA632422006104":"VTRB632422006104",
"VITKAVA632516001100":"VTRB632516001100",
"VITLACH20060ATOM1000":"LACH20060AT0M1000",
"VIT-OT2001999B":"VITU253380001241",
"VITU3811002":"VITU3811002",
"VIT-VITU634921275035":"VITU634921275035",
"VWR-211-0215":"211-0215",
"VWR-211-0217":"211-0217",
"VWR-211-0356":"211-0356",
"VWR-211-0362":"211-0362",
"VWR-212-0437":"212-0437",
"VWR-213-1172P":"213-1172",
"VWR-213-1176P":"213-1176",
"VWR-213-3735":"213-3735",
"VWR-215-0068":"215-0068",
"VWR-215-0069":"215-0069",
"VWR-215-0071":"215-0071",
"VWR-215-0596":"215-0596",
"VWR-215-1832":"215-1832",
"VWR-215-2325":"215-2325",
"VWR-215-7390":"215-7390",
"VWR-331850000279":"KART279",
"VWR-397986311574":"631-1574",
"VWR-442-0354":"442-0354",
"VWR-609-0128":"609-0128",
"VWR-609-0221":"609-0221",
"VWR-612-2723":"612-2723",
"VWR-612-2724":"612-2724",
"VWR-612-2725":"612-2725",
"VWR-613-2425":"613-2425",
"VWR-613-2704":"613-2704",
"VWR-613-2765":"613-2765",
"VWR-613-5900":"613-5900",
"VWR-630-1950H":"630-1950",
"VWR-631-1551":"631-1551",
"VWR-631-9113":"631-9113",
"VWR-632411119025":"VTRB632411119025",
"VWR-632417106250":"VTRB632417106250",
"VWR-636013920205":"GLAS139.202.05",
"VWR-636013920206":"GLAS139.202.06",
"VWR-734-0444":"734-0444",
"VWR-BINZ113076":"BINZ113076",
"VWR-FLME28052":"FLME28052",
"VWR-IBSAWK15003/0":"IBSAWK15003/0",
"VWR-VTRA635991000412":"VTRA635991000412",
"VWR-VTRB632426001250":"VTRB632426001250",
"VWR-VTRB632492003060":"VTRB632492003060",
"VIT23373.320":"23373.320",
"VIT-395321056001":"291-1214",
"VIT624704208125":"BINZ113187",
"VIT-396996130603":"631-0014",
"VWR-612-364":"612-3648",
"REG-VWR-20065.293":"20065.293",
"VIT113-1189":"113-1189",
"VIT113-3877":"113-3877",
"VIT113-3878":"113-3878",
"VWR-613-0868":"613-0868",
"VWR-613-1143":"613-1143",
"VWR-613-5898":"613-5898",
"VWR-613-5902":"613-5902",
"VWR-EPPE3116000.015":"EPPE3116000.015",
"VIT215-9016":"215-9016",
"VIT525-1164":"525-1164",
"VITBRND705838":"BRND705838",
"VITBRND705878":"BRND705878",
"VITBRND705880":"BRND705880",
"VITBRND237049":"BRND237049",
"VIT214-1130":"214-1130",
};


var quantityTable = {
"GAM400927":48,
"VIT113-0645":20,
"VIT113-0646":10,
"VIT216-0791":45,
"VIT216-0792":20,
"VIT216-0793":80,
"VIT216-2639":250,
"VIT238102000":12,
"VIT3313690251350":50,
"VIT331383243045":10,
"VIT-331600471800":100,
"VIT331690211520":200,
"VIT331690221350":50,
"VIT331690226720":50,
"VIT331690229520":50,
"VIT331690250350":50,
"VIT331690251340":100,
"VIT331690251710":100,
"VIT331850001637":10,
"VIT331850041637":10,
"VIT331850041638":10,
"VIT331850061637":10,
"VIT613-3881":25,
"VIT613-4902":25,
"VIT613-5398":25,
"VIT634423014097":250,
"VIT634424155100":78,
"VIT690210170":500,
"VIT690213270":500,
"VIT690250620":100,
"VIT690250720":100,
"VIT690251750":50,
"VIT998000008400":10,
"VITDELT-202847-ks":100,
"VITFLME21056":500,
"VITFLME21361":500,
"VIT113-1189":100,
"VIT113-3877":25,
"VIT113-3878":25,
"VIT215-9016":10,
}
